:: StoryTitle
æ‰˜æ‰˜é‡Œä¹‹å£¶


:: StoryData
{
  "ifid": "BA16F8EA-42F7-407F-A5EC-1FF4DA8BFD8D",
  "format": "SugarCube",
  "format-version": "2.37.3",
  "start": "åˆå§‹ä¹‹åœ°",
  "zoom": 1
}


:: "æˆ‘ä¼šæ€äº†ä½ ï¼Œç„¶åæŠŠä¸œè¥¿å¸¦èµ°" {"position":"1025,1275","size":"100,100"}
ï¼ˆæœªå®Œæˆï¼‰
[[ç‹ä¹‹é—´]]


:: PassageFooter {"position":"1200,100","size":"100,100"}
<<if ['åˆå§‹ä¹‹åœ°', 'ç‰©å“æ ', 'ç§°å·æ '].includes(passage())>>\
	<<set $footerOn to false>>\
<<else>>\
	<<set $footerOn to true>>\
<</if>>\
<<if $footerOn and $me>>\
<hr/>\
$me.name LV$me.level <<if $titles.items.length > 0>>ã€<<print $titles.items.last().name>>ã€‘<</if>>
HP :<meter @value="$me.hp" min="0" @max="$me.max_hp"></meter>
[[ç‰©å“æ ]], [[ç§°å·æ ]]
<</if>>


:: Start {"position":"1350,100","size":"100,100"}
Start
<<script>>
console.log('Start?')
<</script>>


:: StoryCaption {"position":"825,250","size":"100,100"}
$me.name LV$me.level
<<set $expNeed to $nextLevelExp()>>\
<<set _nowPassage to passage()>>\
ç»éªŒå€¼: $me.exp / $expNeed
å›ºæœ‰æ”»å‡»åŠ›: $me.intrinsicPower
å›ºæœ‰é˜²å¾¡åŠ›: $me.intrinsicResistance
è¡€é‡: $me.hp / $me.max_hp
æ­¦å™¨: <<link $me.weapon.name>><<set $temp to $showWeapon()>><</link>>(æ”»å‡»åŠ›: $me.weapon.power)
é˜²å…·: <<link $me.armor.name>><<set $temp to $showArmor()>><</link>> (é˜²å¾¡åŠ›:  $me.armor.resistance)
<<if $me.ring>>é—ç‰©ï¼š<<link $me.ring.name>><<set _temp to $showRelics()>><</link>> <<link "å¸ä¸‹" _nowPassage>><<set $me.ring to null>><</link>><</if>>


:: â€œæˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šç¦»å¼€ï¼ŒæŠŠä¸œè¥¿ç»™æˆ‘â€ {"position":"900,1275","size":"100,100"}
<<silently>>
<<script>>
const usegoblinSummonRod = () => {
	State.variables.me.ring = State.variables.goblinSummonRod;
    State.variables.showDialog('è£…å¤‡é—ç‰©', 'æˆåŠŸè£…å¤‡äº†' + State.variables.goblinSummonRod.name + '!');
}
const goblinSummonRodGroupModifier = (group1, group2, fightHistory) => {
    const spawnedGoblin = fightObjectCopy(State.variables.normalGoblin);
    spawnedGoblin.name = 'å“¥å¸ƒæ—å°é¬¼';
    group1.push(spawnedGoblin);
    console.log('å“¥å¸ƒæ—æƒæ–ä¸º' + group1[0].name + 'çš„é˜Ÿä¼å¬å”¤äº†å“¥å¸ƒæ—å°é¬¼!')
    fightHistory.push('å“¥å¸ƒæ—æƒæ–ä¸º' + group1[0].name + 'çš„é˜Ÿä¼å¬å”¤äº†å“¥å¸ƒæ—å°é¬¼!');
}
State.variables.goblinSummonRod = {name: 'å“¥å¸ƒæ—ç‹çš„æƒæ–', desc: 'å¬å”¤ä¸€åªå“¥å¸ƒæ—ååŒæˆ˜æ–—ã€‚', groupModifier: goblinSummonRodGroupModifier, useCallback: usegoblinSummonRod};

window.addItem(State.variables.inventory.items, State.variables.goblinSummonRod)
State.variables.showDialog('è·å¾—ç‰©å“', 'è·å¾—äº†' + State.variables.goblinSummonRod.name + '!');
State.variables.goblinKingTalked = true;
<</script>>
<</silently>>
ğŸŸ¢ç°åœ¨æˆ‘å¯ä»¥è¿”å›å“¥å¸ƒæ—å‰å“¨ç«™å¹¶ç¦»å¼€ã€‚ï¼ˆåç»­å‰§æƒ…å¾…å®Œæˆï¼‰
[[ç‹ä¹‹é—´]]


:: ä¸€æœ¬ç¿»å¼€çš„ä¹¦ {"position":"525,250","size":"100,100"}
ä»”ç»†ä¸€çœ‹ï¼Œè¿™ä¸æ˜¯ä¸€æœ¬ä¹¦ï¼Œè€Œæ˜¯è‡ªå·±å†™ä¸‹çš„ç¬”è®°ã€‚

æœ€ä¸Šé¢çš„ä¸€é¡µå†™ç€ï¼š

æ˜å¤©å°±æ˜¯æˆ‘çš„åå…­å²ç”Ÿæ—¥äº†ã€‚
ä»æ˜å¤©å¼€å§‹ï¼Œæˆ‘å°±è¦ç¦»å¼€è¿™ä¸ªå®¶ï¼Œè¸ä¸Šç‹¬è‡ªä¸€äººçš„æ—…ç¨‹ã€‚
æˆ‘æ²¡æœ‰è¿‡å»çš„è®°å¿†ã€‚
è€å¤´ä¹Ÿä¸å‘æˆ‘é€éœ²ä»»ä½•ä¸œè¥¿ã€‚
ä¹Ÿè®¸è¿™æ˜¯ä¸€ä¸ªé˜´è°‹ï¼Œä½†æ˜¯ç°åœ¨çš„æˆ‘ä¸å¾—è€ŒçŸ¥ã€‚
å¸Œæœ›æ–°çš„æ—…ç¨‹èƒ½å¤Ÿç»™æˆ‘ç­”æ¡ˆâ€¦â€¦

[[è¿”å›->èµ·å±…å®¤]]


:: ä¸‹ä¸€é¡µ {"position":"850,575","size":"100,100"}
ğŸ–•

æˆ‘è¿˜æƒ³ä½ æ¥å‘Šè¯‰æˆ‘æˆ‘çš„èº«ä¸–å‘¢ï¼Œä½ è¿™ä¸ªBYDä¸å­ç©æ„ã€‚

[[è€å¤´çš„æˆ¿é—´]]

<<script>>
State.variables.oldManLetterRead = true
<</script>>


:: äº¤å‡º5ä¸ªå²è±å§†ç²˜æ¶² {"position":"425,375","size":"100,100"}
<<script>>
let itemName =  'å²è±å§†ç²˜æ¶²'
reduceItemCount(State.variables.inventory.items, itemName, 5)
State.variables.temp = getItem(State.variables.inventory.items, itemName)
addItem(State.variables.inventory.items, State.variables.clownMask, 1)
<</script>>
æŠŠ5ä¸ªå²è±å§†ç²˜æ¶²ç»™äº†è€å¤´ï¼Œç°åœ¨åªå‰©ä¸‹$temp.countä¸ªäº†ã€‚
ä¸è¿‡ä¹Ÿæ²¡ä»€ä¹ˆå¥½å¯æƒœçš„ã€‚

ä½œä¸ºå›æŠ¥ï¼Œè€å¤´ç»™äº†ä½ ä¸€ä¸ªå°ä¸‘é¢å…·ã€‚

[[è¿”å›->å‘è€å¤´æ­è¯]]


:: ä¼‘æ¯ {"position":"525,125","size":"100,100"}
ç»è¿‡å‰§çƒˆçš„ä¼‘æ¯ï¼Œä½“åŠ›æ¢å¤äº†ï¼
<<set $me.hp to $me.max_hp>>\

[[èµ·å±…å®¤]]


:: ä½çŸ®æ—åœ° {"position":"575,525","size":"100,100"}
=ä½çŸ®æ—åœ°=
<<set $slime.hp to $slime.max_hp>>\

å±‹å­æ—è¾¹çš„å°æ ‘æ—ã€‚
è¿™é‡Œç”Ÿæ´»ç€å¾ˆå¤šå¼±å°çš„é­”ç‰©ã€‚
ç›®åŠ›æ‰€åŠçš„åœ°æ–¹å°±æœ‰å¾ˆå¤šå²è±å§†ã€‚
<<link "æ”»å‡»å²è±å§†" "æˆ˜æ–—ç”»é¢">>\
	<<set $lastPassage to 'ä½çŸ®æ—åœ°'>>\
    <<set $enemyNames to ['slime']>>\
<</link>>
<<link "åŒæ—¶æ”»å‡»3åªå²è±å§†" "æˆ˜æ–—ç”»é¢">>\
	<<set $lastPassage to 'ä½çŸ®æ—åœ°'>>\
    <<silently>>\
    <<script>>
        const G = State.variables;
        // spawn slimes
        G.enemyNames = []
        for (let i = 0; i < 3; i++) {
            const enemyName = 'slime_' + i;
            const slimeCloned = structuredClone(G.slime);
            slimeCloned.name = 'å²è±å§†' + i + 'å·';
            G[enemyName] = slimeCloned;
            G.enemyNames.push(enemyName);
        }
    <</script>>
    <</silently>>\
<</link>>

è¿”å›[[å°å±‹å‰åå­—è·¯å£]]


:: ä½ èƒ½ä¸èƒ½å…ˆä»é‚£é‡Œå‡ºæ¥ {"position":"475,1025","size":"100,100"}
â€œæˆ‘ä¹Ÿæƒ³å‡ºæ¥ï¼Œå¯è¿™ä¸œè¥¿ä¸æ”¯æŒç»†å¾®çš„è°ƒèŠ‚ã€‚å”‰æˆ‘ç°åœ¨æ²¡æ—¶é—´å’Œä½ è§£é‡Šé‚£ä¹ˆå¤šï¼Œä½ èƒ½ä¸èƒ½å‘Šè¯‰æˆ‘è¿™é‡Œæ˜¯å“ªé‡Œï¼Ÿâ€
â€œæ–¹ä½ä¸Šåº”è¯¥æ˜¯<span class='important'>åº•é‡Œæ–¯ç‹å›½çš„ä¸œå—</span>ã€‚â€
â€œå“¦ï¼å±…ç„¶æ¥åˆ°è¿™ç§åœ°æ–¹äº†å—ã€‚â€
â€œä½ ç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿâ€
â€œä¸€æ—¶åŠä¼šç»™ä½ è§£é‡Šä¸æ¸…æ¥šï¼Œæ—¶é—´å¿«åˆ°äº†ï¼Œä½ æœ‰æœºä¼šçš„è¯åˆ°<span class='important'>å¸ƒé‡Œæ–¯å¦ç‹å›½</span>æ¥æ‰¾æˆ‘ï¼Œå°±è¯´æ˜¯æ‰¾<span class='important'>å¤©æ‰ç§‘å­¦å®¶å¢æ©</span>åˆ«äººå°±æ‡‚äº†ã€‚åˆ°æ—¶å€™æˆ‘å†å‘ä½ è§£é‡Šã€‚â€
çœ¼çœ‹ç€é‚£äººçš„è…¿ä¸Šå‡ºç°äº†ä¸€äº›äº®ç»¿è‰²çš„å™ªç‚¹ï¼Œè¿™è¿‡åˆ†è¯¡å¼‚çš„å…‰æ™¯è®©$me.nameæ„Ÿåˆ°æ¯›éª¨æ‚šç„¶ã€‚

"é‡è§èƒ½å¤Ÿäº¤æµçš„äººçœŸæ˜¯ä¸å¯æ€è®®ã€‚å¤šäºåº•é‡Œæ–¯å’Œå¸ƒé‡Œæ–¯å¦æ˜¯é‚»è¿‘å›½å®¶ï¼Œä½¿ç”¨åŒæ ·çš„è¯­è¨€ã€‚å¦‚æœæ˜¯æ›´è¿œæˆ–è€…æ˜¯æŸäº›å¤æ€ªçš„åœ°æ–¹å°±éš¾è¯´äº†ã€‚â€œ
è¿™è¿˜ä¸ç®—æ˜¯å¤æ€ªçš„åœ°æ–¹å—ã€‚
â€ä½ è¯´ä½ åœ¨å“¥å¸ƒæ—å·¢ç©´ï¼Œé‚£ä½ åº”è¯¥æ˜¯å†’é™©è€…å¯¹å§ã€‚æˆ‘å¾…ä¼šç»™ä½ <span class='important'>ä¼ é€ä¸ªä¸œè¥¿è¿‡æ¥</span>ï¼Œå¸Œæœ›èƒ½å¯¹ä½ çš„å†’é™©æœ‰å¸®åŠ©ã€‚å¸Œæœ›æˆ‘ä»¬æœ‰ç¼˜å†è§ã€‚æ²¡æ—¶é—´äº†ï¼Œå°±"
è¯éŸ³æˆ›ç„¶è€Œæ­¢ï¼Œéšä¹‹æ¶ˆå¤±çš„æ˜¯ç”·äººçš„åŠèº«ï¼Œåªç•™ä¸‹äº†å’Œå¾€å¸¸ä¸€æ ·çš„å²©é¢ã€‚

[[ç‰‡åˆ»ä¹‹å]]


:: åˆå§‹ä¹‹åœ° {"position":"700,100","size":"100,100"}
<<set $default_weapon to {name: 'ç©ºæ‰‹', power: 1, desc: 'æ‹³å¤´å°±æ˜¯æœ€å¥½çš„æ­¦å™¨ã€‚'}>>\
<<set $default_armor to {name: 'è¿åŠ¨æœ', resistance: 1, desc: 'å±…å®¶ç”¨ã€‚'}>>\
<<set $me to {name: 'ä½ çˆ¹', hp: 100, max_hp: 100, weapon: $default_weapon, armor: $default_armor, intrinsicPower: 0, intrinsicResistance: 0, level: 1, exp: 0}>>\
æˆ‘çš„åå­—å«ä½œï¼š
<<textbox "$me.name" "çˆ¶äº²">>

[[è¿›å…¥æ¸¸æˆ->èµ·å±…å®¤]]


<<set $inventory to {desc: 'ç‰©å“æ ', items: []}>>
<<set $titles to {desc: 'ç§°å·', items: []}>>

<<set $beginnerWeaponGot to false>>
<<set $beginnerWeapon to {name: 'æœ¨å‰‘', power: 2, desc: 'å¹³å‡¡çš„æœ¨å‰‘ã€‚'}>>
<<set $beginnerArmor to {name: 'é¹¿çš®å¤¹å…‹', resistance: 2, desc: 'éšå¤„å¯è§çš„é¹¿çš®å¤¹å…‹ã€‚'}>>
<<set $bloodedIronSword to {name: 'æŸ“è¡€çš„é“å‰‘', power: 5, desc: 'ç”±äºè¡€æ±¡å˜é’äº†ä¸€äº›ã€‚'}>>
<<set $bloodedDeerskinArmor to {name: 'æŸ“è¡€çš„é¹¿çš®å¤¹å…‹', resistance: 4, desc: 'æ•£å‘ç€ä»¤äººæ¶å¿ƒçš„è…¥è‡­ã€‚'}>>

<<set $footerOn to true>>

/* NPC & Monsters */
<<script>>
console.log('HELLO?')
State.variables.slimeDrop =  {name: 'å²è±å§†ç²˜æ¶²', desc: 'å²è±å§†æ‰è½çš„ç²˜ç¨ æ¶²ä½“ï¼Œåº”è¯¥ä¸ä¼šæœ‰äººéœ€è¦å§ï¼Ÿ'};
State.variables.mountainGoblinSoul =  {name: 'å±±å²­å“¥å¸ƒæ—çš„çµé­‚', desc: 'å±±å²­å“¥å¸ƒæ—çš„åšéŸ§çµé­‚ã€‚'};
State.variables.normalGoblinSoul =  {name: 'æˆå¹´å“¥å¸ƒæ—çš„çµé­‚', desc: 'æˆå¹´å“¥å¸ƒæ—çš„å‘å¾®çµé­‚ã€‚'};
State.variables.oldMan = {name: 'è€å¤´', max_hp: 100, hp: 100, power: 5, resistance: 2, exp: 100};
State.variables.slime = {
	name: 'å²è±å§†', 
    exp: 3,
    max_hp: 10,
    hp: 10, 
    power: 1, 
    resistance: 1, 
    drops: [{
    	item: State.variables.slimeDrop, 
        chance: 0.6
    }]
}
State.variables.mountainGoblin = {
	name: 'å±±å²­å“¥å¸ƒæ—', 
    exp: 150,
    max_hp: 120,
    hp: 120, 
    power: 10, 
    resistance: 16, 
    drops: [{
    	item: State.variables.mountainGoblinSoul, 
        chance: 1.0
    }]
}
State.variables.theOutpostMountainGoblin = structuredClone(State.variables.mountainGoblin);
State.variables.normalGoblin = {
	name: 'æˆå¹´å“¥å¸ƒæ—', 
    exp: 60,
    max_hp: 60,
    hp: 60, 
    power: 9, 
    resistance: 6, 
    drops: [{
    	item: State.variables.normalGoblinSoul, 
        chance: 0.4
    }]
}
State.variables.clownMask = {
	name: 'å°ä¸‘é¢å…·',  desc: 'çœ‹èµ·æ¥æœ‰äº›è¯¡å¼‚çš„é¢å…·ï¼Œèƒ½å¤Ÿå“å“­å°å­©ã€‚'
}
State.variables.oldManSlayer = {
	name: 'ä¿„ç‹„æµ¦æ–¯',  desc: 'åªæ˜¯æ€æ­»äº†ä¸ªè€å¤´è€Œå·²ï¼Œæœ‰ä»€ä¹ˆå¥½å¤§æƒŠå°æ€ªçš„ã€‚'
}
State.variables.slimeSlayer = {
	name: 'å²è±å§†æ€æ‰‹',  desc: 'æœ€å¥½ä¸è¦è®©åŠ¨ç‰©ä¿æŠ¤åä¼šçŸ¥é“ã€‚'
}
State.variables.goblinSlayer = {
	name: 'æŠ¤ç”²å‡»ç ´è€…',  desc: 'ç¬¬ä¸€æ¬¡å‡»è´¥å±±å²­å“¥å¸ƒæ—ã€‚'
}
State.variables.healMySelf = function healMySelf(percentage){
	healing(State.variables.me, percentage);
}
State.variables.useSmallHealingPotion = function useSmallHealingPotion(){
	healing(State.variables.me, 0.2);
    reduceItemCount(State.variables.inventory.items, 'å°å›å¤ç“¶');
}
State.variables.smallHealingPotion = {
	name: 'å°å›å¤ç“¶',  desc: 'å›å¤20%HPã€‚', useCallback: State.variables.useSmallHealingPotion
}
// å¢åŠ ç»éªŒ
State.variables.levelUpMe = function levelUpMe(){
	window.levelUp(State.variables.me)
}
State.variables.addExp = function  addExp(exp){
	console.log('è·å–äº†' + exp + 'ç‚¹ç»éªŒ')
	let {newExp, newLevel, levelsGained} = expGot(State.variables.me.exp, exp, State.variables.me.level, State.variables.levelUpMe);
    console.log('newExp ' + exp + 'ç‚¹ç»éªŒ')
    State.variables.me.exp = newExp;
}
State.variables.nextLevelExp = function(){
	return expCurve(State.variables.me.level);
}
State.variables.showDialog = function(title, text){
    Dialog.create(title);
    Dialog.wiki(text);
    Dialog.open();
}
State.variables.showDialogWithTextList = function(title, textList){
    Dialog.create(title);
	let text = textList.join('\n');; // è¯·å¸®æˆ‘è¡¥å……è¿™ä¸€è¡Œï¼Œä½¿ç”¨æ¢è¡Œç¬¦æ¥æ¢è¡Œå³å¯
    Dialog.wiki(text);
    Dialog.open();
}
State.variables.showWeapon = function(){
	let title = State.variables.me.weapon.name
    let desc = State.variables.me.weapon.desc
	State.variables.showDialog(title, desc)
}
State.variables.showArmor = function(){
	let title = State.variables.me.armor.name
    let desc = State.variables.me.armor.desc
	State.variables.showDialog(title, desc)
}
State.variables.showRelics = function(){
	let title = State.variables.me.ring.name
    let desc = State.variables.me.ring.desc
	State.variables.showDialog(title, desc)
}
State.variables.armorPiercingRingDamageCalculator = function (me, enemy, fightHistory = []){
    fightHistory.push('ç ´ç”²æŒ‡ç¯æ— è§†' + enemy.name + '30%é˜²å¾¡å€¼è¿›è¡Œæ”»å‡»!')
	const damage = me.power - Math.floor(enemy.resistance * 0.7 + 1);
    return Math.max(1, damage);
}
State.variables.armorPiercingRingUseCb = function(){
	State.variables.me.ring = State.variables.armorPiercingRing;
    State.variables.showDialog('è£…å¤‡æŒ‡ç¯', 'æˆåŠŸè£…å¤‡äº†ç ´ç”²æŒ‡ç¯!');
}
State.variables.armorPiercingRing = {name: 'ç ´ç”²æŒ‡ç¯', desc: 'æŒ‡ç¯çš„æ°´æ™¶é‡Œå°å­˜ç€ä¸€å°ç‰‡éª¨å¤´ã€‚', damageCalculator : State.variables.armorPiercingRingDamageCalculator, useCallback: State.variables.armorPiercingRingUseCb}
// State.variables.me.ring = State.variables.armorPiercingRing;
State.variables.globalUseCallback = function(idx){
	console.log('globalUseCallback ' + idx);
    console.log('I am going to call ' + State.variables.inventory.items[idx].name + ' callback');
    State.variables.inventory.items[idx].useCallback()
}
State.variables.showDialogFightHistory = function(){
	State.variables.showDialogWithTextList('æˆ˜æ–—è®°å½•', State.variables.fightHistory)
}
// 2024.10.25å°†enemyVarNameåºŸå¼ƒï¼Œæ”¹æˆenemiesä»¥æ”¯æŒç»„æˆ˜æ–—
// 2024.10.25ç”±äºå¼•ç”¨åœ¨æ¯ä¸ªæ–°æ®µè½éƒ½ä¼šè¢«ç ´åï¼Œåªèƒ½é€šè¿‡ä¿å­˜åå­—çš„æ–¹å¼æ¥ä¿æŒè”ç³»
State.variables.enemyNames = [];
console.log('I am done')
<</script>>

<<script>>
    window.dd = State.variables
<</script>>


:: å‘ç©¿å¢™è€…æ­è¯ {"position":"475,900","size":"100,100"}
é‚£æ˜¯ååˆ†è¯¡å¼‚çš„å…‰æ™¯ï¼Œé‚£äººç›´ç›´ç«™ç€ï¼Œä¸ŠåŠèº«å®Œå…¨æ²¡å…¥äº†å²©å±‚ä¹‹ä¸­ã€‚
æˆ–è€…è¯´ï¼Œåƒæ˜¯ä»å²©çŸ³ä¸­é•¿å‡ºæ¥ä¸¤æ¡è…¿ä¸€æ ·ã€‚

å‘å‡ºå£°éŸ³ï¼Œè¯•å›¾å¸å¼•é‚£ä¸ªä¸œè¥¿çš„æ³¨æ„ã€‚
â€œä½ ï¼Œä½ å¥½â€¦â€¦â€<span class='good'>$me.name</span>è¯´ã€‚

â€œæœ‰äººåœ¨é‚£é‡Œï¼Ÿâ€é‚£ä¸ªä¸œè¥¿ç”¨ä¸€ä¸ªç”·äººçš„å£°éŸ³å›è¯äº†ã€‚
â€œå¯¹ã€‚â€
â€œä½ èƒ½å‘Šè¯‰æˆ‘è¿™é‡Œæ˜¯ä»€ä¹ˆåœ°æ–¹å—ï¼Ÿâ€
â€œåº”è¯¥æ˜¯å“¥å¸ƒæ—çš„å·¢ç©´ã€‚â€
æ²‰é»˜äº†ä¸€ä¼šå„¿ã€‚
â€œå“ªä¸ªå›½å®¶çš„å“ªä¸ªæ–¹ä½ï¼Ÿâ€ç”·äººé—®é“ã€‚

â€œ[[ä½ èƒ½ä¸èƒ½å…ˆä»é‚£é‡Œå‡ºæ¥]]ï¼Ÿâ€


:: å‘è€å¤´æ­è¯ {"position":"550,375","size":"100,100"}
è€å¤´ï¼šä»Šå¤©æ˜¯ä½ çš„åå…­å²ç”Ÿæ—¥ã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œ<span class='good'>$me.name</span>ï¼Œä½ å°†è¦å¼€å§‹ç‹¬è‡ªçš„å†’é™©ç”Ÿæ´»ã€‚

è€å¤´ï¼šç°åœ¨ï¼Œæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡äº¤ç»™ä½ ï¼Œå»<span class='important'>æ€æ­»5åªå²è±å§†ï¼Œå¸¦å›å®ƒä»¬æ‰è½çš„ç²˜æ¶²</span>ï¼Œå‘æˆ‘è¯æ˜ä½ çš„èƒ½åŠ›ã€‚

è€å¤´ï¼šå²è±å§†ç»å¸¸åœ¨å±‹å¤–çš„<span class='important'>ä½çŸ®æ—åœ°</span>å‡ºæ²¡ã€‚ä½ éœ€è¦å…ˆå‡ºå»å±‹å¤–ï¼Œæ‰èƒ½å‰å¾€ä½çŸ®æ—åœ°ã€‚
\
<<silently>>\
<<script>>
let hasSlimeDrop = checkHavingItem(State.variables.inventory.items, 'å²è±å§†ç²˜æ¶²')
State.variables.hasSlimeDrop = hasSlimeDrop
if(hasSlimeDrop){
	State.variables.temp = getItem(State.variables.inventory.items, 'å²è±å§†ç²˜æ¶²')
}
<</script>>
<</silently>>\
\
<<if $hasSlimeDrop>>
è€å¤´ï¼š ä½ ç°åœ¨æ‹¥æœ‰$temp.countä¸ªå²è±å§†ç²˜æ¶²ã€‚
	<<if $temp.count >= 5>>
    	ğŸŸ¢[[äº¤å‡º5ä¸ªå²è±å§†ç²˜æ¶²]]
	<</if>>
<<else>>
è€å¤´ï¼š ä½ è¿˜æ²¡æœ‰æ‹¿åˆ°å²è±å§†ç²˜æ¶²ã€‚
<</if>>

[[è¿”å›->å¤§å…]]


:: å¬å“¥å¸ƒæ—ç‹è¯´è¯ {"position":"900,1150","size":"100,100"}
å“¥å¸ƒæ—ç‹ç”¨å˜¶å“‘ï¼Œèµ°è°ƒçš„<span class='important'>ç‹å›½å…¬ç”¨è¯­</span>å¼€å£è¯´è¯äº†ï¼š

â€œä½ æƒ³è¦èƒœåˆ©çš„è¯æ˜â€”â€”æˆ‘æŠŠè¿™æŸ„æƒæ–ç»™ä½ ï¼Œæ‹¿ä¸Šå®ƒç¦»å¼€ï¼Œåˆ«å†å›æ¥ã€‚â€
å“¥å¸ƒæ—ä¼šç‹å›½å…¬ç”¨è¯­å·²ç»è¶³å¤Ÿä»¤äººåƒæƒŠäº†ï¼Œå¯æ˜¯æ›´åŠ ä»¤æˆ‘æƒŠè®¶çš„æ˜¯ï¼Œå®ƒå¥½åƒè¦æ”¾æˆ‘ç¦»å¼€ã€‚

â€œä¸ºä»€ä¹ˆï¼Ÿâ€
â€œå› ä¸ºä½ ä»¤æˆ‘ææƒ§ã€‚â€å“¥å¸ƒæ—ç‹è¿™æ ·è¯´äº†ã€‚

èº«å¤„è¿™æ ·çš„å¢ƒé‡ï¼Œæ„Ÿåˆ°ææƒ§çš„æ˜¯æˆ‘æ‰å¯¹å§ã€‚
â€œæ´»ç€çš„ä¸œè¥¿éƒ½æœ‰å¼±ç‚¹ï¼Œä¸æ„¿æ„æ”¾å¼ƒçš„ä¸œè¥¿ï¼Œå°±æ˜¯å®ƒä»¬æœ€å¤§çš„å¼±ç‚¹ã€‚å¯æ˜¯ä½ å´æ²¡æœ‰è¿™æ ·çš„ä¸œè¥¿ï¼Œä½ æ€æˆ®æ—¶çš„çœ¼ç›ï¼Œæ²¡æœ‰ä»»ä½•æ„Ÿæƒ…çš„çœ¼ç›ï¼Œå½“æˆ‘ç”¨è¿™ä¸ªæ°´æ™¶çƒçœ‹è§çš„æ—¶å€™å°±æ˜ç™½äº†ã€‚â€
è¿™ä¸ªå“¥å¸ƒæ—çš„è¯æ±‡é‡è¿˜æŒºä¸°å¯Œçš„ï¼Œâ€œæ˜ç™½ä»€ä¹ˆï¼Ÿâ€æˆ‘é—®ã€‚
â€œ<span class='important'>ä½ ç°åœ¨è¿˜ä¸å±äºè¿™ä¸ªä¸–ç•Œ</span>ã€‚â€

åˆ°åšé€‰æ‹©çš„æ—¶å€™äº†:
[[â€œæˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šç¦»å¼€ï¼ŒæŠŠä¸œè¥¿ç»™æˆ‘â€]]ã€‚
[["æˆ‘ä¼šæ€äº†ä½ ï¼Œç„¶åæŠŠä¸œè¥¿å¸¦èµ°"]]ã€‚


:: å“¥å¸ƒæ—å‰å“¨ç«™ {"position":"725,900","size":"100,100"}
<<set $normalGoblin.hp to $normalGoblin.max_hp>>\
=å“¥å¸ƒæ—å‰å“¨ç«™=

ä¸€ä¸ªé»‘ä¹ä¹çš„æ´å£é€šå¾€[[å·¢ç©´æ·±å¤„]]ã€‚

æ´å£å¤–è¾¹ç¨å¾®å¼€é˜”ä¸€ç‚¹çš„åœ°æ–¹ï¼Œå››å¤„ç«™ç€ä¸€äº›æ— æ‰€äº‹äº‹çš„å“¥å¸ƒæ—ã€‚
åœ¨é»‘æš—çš„æ©ç›–ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥<<link "æ”»å‡»å“¥å¸ƒæ—" "æˆ˜æ–—ç”»é¢">>
	<<set $lastPassage to 'å“¥å¸ƒæ—å‰å“¨ç«™'>>\
    <<set $enemyNames to ['normalGoblin']>>\
<</link>>è€Œä¸ä¼šå¼•èµ·éªšä¹±ã€‚
<<link "åŒæ—¶æ”»å‡»3åªå“¥å¸ƒæ—" "æˆ˜æ–—ç”»é¢">>\
	<<set $lastPassage to 'å“¥å¸ƒæ—å‰å“¨ç«™'>>\
    <<silently>>\
    <<script>>
        const G = State.variables;
        // spawn goblins
        G.enemyNames = []
        for (let i = 0; i < 3; i++) {
            const enemyName = 'normalGoblin_' + i;
            const goblinCloned = structuredClone(G.normalGoblin);
            goblinCloned.name = 'å¹³å‡¡å“¥å¸ƒæ—' + i + 'å·';
            G[enemyName] = goblinCloned;
            G.enemyNames.push(enemyName);
        }
    <</script>>
    <</silently>>\
<</link>>

åœ°ä¸Šèººç€æ­»å»çš„åŒä¼´ä»¬çš„å°¸ä½“ã€‚
ä»”ç»†çœ‹çš„è¯èƒ½å¤Ÿå‘ç°ï¼Œ[[æ¢…åˆ©çš„å°¸ä½“åœ¨å‘å…‰]]ã€‚

[[èº²è¿›å²©çŸ³è£‚ç¼->å“¥å¸ƒæ—å·¢ç©´è£‚ç¼]]


:: å“¥å¸ƒæ—å·¢ç©´è£‚ç¼ {"position":"600,775","size":"100,100"}
=ç‹­çª„çš„å²©çŸ³è£‚ç¼=

æ˜æš—çš„æ´ç©´ï¼Œç©ºæ°”ä¸­æ¼‚æµ®ç€è…è‚‰å’Œç²ªä¾¿çš„å‘³é“ã€‚

<<if not $consideredInCave>>
[[æ€è€ƒæˆ‘ç°åœ¨åº”è¯¥åšçš„äº‹æƒ…]]
<<else>>
ğŸŸ¢å‰å¾€[[å“¥å¸ƒæ—å‰å“¨ç«™]]ã€‚
<<if $meetWallPenetrater is false and random(100) < 100>>\
ğŸŸ å¦‚æœæˆ‘æ²¡çœ‹é”™çš„è¯ï¼Œå²©çŸ³é‡Œé¢é•¿å‡ºæ¥ä¸€ä¸ªäººã€‚[[å‘ä»–æ­è¯->å‘ç©¿å¢™è€…æ­è¯]]
<</if>>\
<</if>>\


:: å¤§å… {"position":"700,375","size":"100,100"}
=å¤§å…=

è€æ—§æœ¨å¤´æˆ¿å­çš„å®¢å…ã€‚
ä»è¿™é‡Œå¯ä»¥å‰å¾€[[å°å±‹å‰åå­—è·¯å£]]ï¼Œ[[èµ·å±…å®¤]]å’Œ[[è€å¤´çš„æˆ¿é—´]]ã€‚

å¦‚æœæƒ³è¦ä¼‘æ¯çš„è¯ï¼Œæˆ‘éœ€è¦å…ˆè¿”å›èµ·å±…å®¤ã€‚

<<if $oldMan.hp > 0>>
å®¢å…ä¸­å¤®ç«™ç€ä¸€ä¸ª$oldMan.nameã€‚\
<<link "æ”»å‡»" "æˆ˜æ–—ç”»é¢">>
	<<set $lastPassage to 'å¤§å…'>>\
    <<script>>State.variables.enemyNames = ['oldMan'];<</script>>
<</link>>
[[å‘è€å¤´æ­è¯]]
<<else>>
å®¢å…ä¸­å¤®èººç€$oldMan.nameçš„å°¸ä½“ã€‚
ğŸŸ¢ç°åœ¨ï¼Œæˆ‘å¯ä»¥ä»å°å±‹å‰é¢çš„åå­—è·¯å£ç¦»å¼€ã€‚
<</if>>


:: å°å±‹å‰åå­—è·¯å£ {"position":"725,525","size":"100,100"}
=å°å±‹å‰åå­—è·¯å£=

ä»è¿™é‡Œå¯ä»¥çœ‹è§ç ´çƒ‚çš„[[å°å±‹->å¤§å…]]ï¼Œå’Œå°å±‹èƒŒåçš„[[ä½çŸ®æ—åœ°]]ã€‚

å¤§é©¬è·¯å¦‚æ­¤ç¬”ç›´ï¼Œå®ƒä¸€å®šå¯ä»¥å¸¦æˆ‘å»å¾€ä»»ä½•åœ°æ–¹ã€‚

<<if $oldMan.hp < 1>>
ğŸŸ¢æ˜¯æ—¶å€™[[ç¦»å¼€è¿™é‡Œ]]äº†ã€‚
<</if>>


:: å·¢ç©´æ·±å¤„ {"position":"900,900","size":"100,100"}
=<<print passage()>>=

å“¥å¸ƒæ—å·¢ç©´æ·±å¤„ï¼Œè«åçš„è…è‡­æ›´åŠ ä¸¥é‡äº†ã€‚

<<if $theOutpostMountainGoblin.hp > 0>>\
ä¸€åªæ‹¿ç€ç«æŠŠçš„<span class='red'>å¤§å—å¤´å“¥å¸ƒæ—</span>åœ¨å·¡é€»ã€‚<<link "æ”»å‡»å¤§ä¸ªå­å“¥å¸ƒæ—" "æˆ˜æ–—ç”»é¢">>
	<<set $lastPassage to 'å·¢ç©´æ·±å¤„'>>\
    <<set $enemyNames to ['theOutpostMountainGoblin']>>\
<</link>>\
<<else>>\
åœ°ä¸Šèººç€å¤§å—å¤´å“¥å¸ƒæ—çš„å°¸ä½“ã€‚
ğŸŸ¢ç°åœ¨æˆ‘å¯ä»¥å‰å¾€ç¥­å›ï¼Œ[[ç‹ä¹‹é—´]]ã€‚
<</if>>

è¿”å›[[å“¥å¸ƒæ—å‰å“¨ç«™]]ã€‚


:: æ€è€ƒæˆ‘ç°åœ¨åº”è¯¥åšçš„äº‹æƒ… {"position":"600,900","size":"100,100"}
é€‰æ‹©æ°¸è¿œåªæœ‰ä¸¤ç§ï¼Œå‰è¿›ï¼Œæˆ–è€…æ˜¯åé€€ã€‚

å¦‚ä»Šä»˜å‡ºäº†æƒ¨é‡çš„ä»£ä»·ï¼Œæˆ‘å·²ç»å¤±å»äº†åé€€çš„é€‰é¡¹ã€‚
æˆ‘å¿…é¡»å–ä¸‹å“¥å¸ƒæ—ç‹çš„å¤´é¢…ï¼Œä»¥æ­¤å‡­åŠæ­»å»çš„é˜Ÿå‹ä»¬ã€‚

[[è¿”å›->å“¥å¸ƒæ—å·¢ç©´è£‚ç¼]]
<<script>>
State.variables.consideredInCave = true;
<</script>>


:: æˆ˜æ–—ç”»é¢ {"position":"1000,225","size":"100,100"}
=æˆ˜æ–—=
<<silently>>\
<<script>>
console.log('Second check');
const enemies = State.variables.enemyNames.map(name => State.variables[name]);
const isGroupAlive = group => group.some(obj => obj.hp > 0);
State.variables.enemyNameString = ''
enemies.map(obj => State.variables.enemyNameString += obj.name + ' ')
if (!isGroupAlive(enemies)){
	console.log('Enemies All Dead!');
    State.variables.error = true;
}else{
	State.variables.error = false;
	// å¤„ç†ä¸»è§’çš„powerå’Œresistance
	const me = State.variables.me;
	me.power = me.intrinsicPower + me.weapon.power;
	me.resistance = me.intrinsicResistance + me.armor.resistance;
	const meCopy = fightObjectCopy(me);
	// æµ‹è¯•ç”¨ä»£ç 
    console.log('æ‰“å°æ‰€æœ‰æ•Œäººçš„åå­—:')
    enemies.map(obj => console.log(obj.name));
    console.log('æ‰“å°æˆ‘è‡ªå·±:')
	console.log(State.variables.me);
	// å¤„ç†æ•Œäººçš„objCopy
	// const enemy = State.variables[State.variables.enemyVarName];
    const enemiesCopy = enemies.map(enemy => fightObjectCopy(enemy));
	// 2024.10.21 å¢åŠ æŒ‡ç¯æ•ˆæœ
	const cb = {'g1': {}, 'g2': {}};
	if (State.variables.me.ring){
        cb['g1'][0] = {}
        if (State.variables.me.ring.damageCalculator){
            cb['g1'][0]['damageCalculator'] = State.variables.me.ring.damageCalculator;
        }
        if (State.variables.me.ring.groupModifier){
            cb['g1'][0]['groupModifier'] = State.variables.me.ring.groupModifier;
        }
	}
	// let fightHistory = fight(meCopy, enemyCopy, beforeFightCallbacks);
    let fightHistory = groupFight([meCopy], enemiesCopy, cb);
	State.variables.fightHistory = fightHistory; // ç”¨äºåç»­å±•ç¤ºè®°å½•
	window.temp = fightHistory;
	// console.log(fightHistory);
	State.variables.me.hp = meCopy.hp;
    for (let i = 0; i < enemies.length; i++) {
        enemies[i].hp = enemiesCopy[i].hp;
    }
    console.log(enemies[0])
	State.variables.enemy = enemies[0];  //è€ƒè™‘åˆ°å…¼å®¹æ€§é—®é¢˜
}
<</script>>
<</silently>>\

<<if $error>>\
	$enemyNameStringå·²ç»æ­»äº†ï¼Œè¯·ä¸è¦åå¤é­å°¸ï¼
<<else>>\
å‘$enemyNameStringå‘èµ·äº†æ”»å‡»ï¼
<<if $me.hp < 1>>\
<<goto "æ­»äº¡">>\
<<else>>\
<span class='good'>$enemyNameStringè¢«ä½ æ€æ­»äº†ï¼</span>
<<include 'ç‰©å“æ‰è½'>>
<<include 'æ€æ­»æ€ªç‰©å›è°ƒ'>>
<<button "æŸ¥çœ‹æˆ˜æ–—è®°å½•">><<set _temp to $showDialogFightHistory()>><</button>>
<</if>>\
<</if>>\

<<link "è¿”å›" $lastPassage>><</link>>


:: æ€æ­»æ€ªç‰©å›è°ƒ {"position":"1250,425","size":"100,100"}
<<silently>>\
<<script>>
const G = State.variables;
G.enemyNames.map(varName => {
	G.addExp(G[varName].exp);
    if (varName.startsWith('slime')){
        console.log('æ€æ­»å²è±å§†')
        addItem(State.variables.titles.items, State.variables.slimeSlayer, 1)
    }else if (varName == 'oldMan'){
        console.log('æ€æ­»è€å¤´')
        if (!checkHavingItem(State.variables.titles.items, 'ä¿„ç‹„æµ¦æ–¯')){
            addItem(State.variables.titles.items, State.variables.oldManSlayer)
        }
    }else if (varName == 'theOutpostMountainGoblin'){
        if (!State.variables.me.ring || State.variables.me.ring.name != 'ç ´ç”²æŒ‡ç¯'){
            console.log('ä¸ä½¿ç”¨ç ´ç”²æˆ’æŒ‡å‡»ç ´å±±å²­å“¥å¸ƒæ—');
            const title = {name: 'æ‰‹æ’•é‡å¦è€…', desc: 'ä¸ä½¿ç”¨ç ´ç”²æˆ’æŒ‡å‡»ç ´å‰å“¨ç«™çš„å±±å²­å“¥å¸ƒæ—ã€‚'}
            addItem(State.variables.titles.items, title)
        }else{
            const title = {name: 'å°å¼Šè€…', desc: 'ä½¿ç”¨ç ´ç”²æˆ’æŒ‡å‡»ç ´å‰å“¨ç«™çš„å±±å²­å“¥å¸ƒæ—ã€‚'}
            addItem(State.variables.titles.items, title);
        }
        console.log('æ€æ­»å‰å“¨ç«™çš„å±±å²­å“¥å¸ƒæ—');
    }
})
<</script>>
<</silently>>\


:: æ¢…åˆ©çš„å°¸ä½“åœ¨å‘å…‰ {"position":"725,1025","size":"100,100"}
æ¢…åˆ©æ˜¯æˆ‘ä»¬é˜Ÿä¼ä¸­çš„ç‰§å¸ˆã€‚
å¥¹ç»™è‡ªå·±æ–½åŠ äº†è¯…å’’ï¼Œä¸€æ—¦æ­»äº¡å°±ä¼šè¿‘ä¹æ°¸ä¹…åœ°ä¸ºå››å‘¨æ–½åŠ æ²»ç–—å…‰ç¯ã€‚
å¦‚æœç¨å¾®é è¿‘å°±èƒ½å¤Ÿå›å¤å¥åº·ã€‚

<<link "ä½¿ç”¨æ¢…åˆ©è¿›è¡Œæ²»ç–—" "æ¢…åˆ©çš„å°¸ä½“åœ¨å‘å…‰">><<set $temp to $healMySelf(0.05)>><</link>>
[[è¿”å›->å“¥å¸ƒæ—å‰å“¨ç«™]]


:: æ­»äº¡ {"position":"1125,250","size":"100,100"}
=æ­»äº¡=

<span class='danger'>ä½ è¢«$enemy.nameæ€æ­»äº†ï¼</span>
$enemy.nameçš„HPå‰©ä½™$enemy.hpç‚¹ï¼Œä¸‹æ¬¡å†åŠªåŠ›å§ã€‚

<<button "æŸ¥çœ‹æˆ˜æ–—è®°å½•">><<set _temp to $showDialogFightHistory()>><</button>>

ç‚¹å‡»ä¾§è¾¹æ çš„"RESTART"é‡æ–°å¼€å§‹æ¸¸æˆã€‚


:: ç‰‡åˆ»ä¹‹å {"position":"475,1150","size":"100,100"}
ç¨è¿‡ç‰‡åˆ»ï¼Œä¼ æ¥äº†å°å°çš„å½“å•·å£°ï¼Œå¥½åƒæœ‰ä»€ä¹ˆä¸œè¥¿æ‰åœ¨äº†åœ°ä¸Šã€‚
éš¾é“è¯´æ˜¯åˆšåˆšé‚£äººè¯´çš„ä¸œè¥¿å—ï¼Ÿ

åœ¨åœ°ä¸Šæ‘¸ç´¢äº†ä¸€ä¸‹ï¼Œ<span class='good'>æ‰¾åˆ°äº†ä¸€æšæŒ‡ç¯</span>ã€‚

[[è¿”å›->å“¥å¸ƒæ—å·¢ç©´è£‚ç¼]]
<<silently>>\
<<script>>
	addItem(State.variables.inventory.items, State.variables.armorPiercingRing);
    State.variables.meetWallPenetrater = true;
    State.variables.showDialog('è·å¾—ç‰©å“', 'è·å¾—äº†' + State.variables.armorPiercingRing.name + '!');
<</script>>
<</silently>>\


:: ç‰©å“æ‰è½ {"position":"1125,375","size":"100,100"}
<<silently>>\
<<script>>
State.variables.dropLog = '';
const enemies = State.variables.enemyNames.map(name => State.variables[name]);
enemies.forEach(enemy => {
    if ('drops' in enemy) {
        // éšæœºè®¡ç®—æ‰è½çš„ç‰©å“
        let items = dropItems(enemy.drops);
        console.log(items);

        // ç”Ÿæˆæ‰è½ä¿¡æ¯æ–‡æœ¬å¹¶è¿½åŠ åˆ°tempä¸­
        if (items.length > 0){
        	let text = dropString(items);
        	State.variables.dropLog += enemy.name + 'æ‰è½äº†' + text + '\n';  // æ·»åŠ æ¢è¡Œç¬¦ï¼Œä¾¿äºåŒºåˆ†å¤šä¸ªæ•Œäººæ‰è½çš„ä¿¡æ¯
            addToInventory(State.variables.inventory.items, items);
        } else {
        	State.variables.dropLog += enemy.name + 'ä»€ä¹ˆéƒ½æ²¡æœ‰æ‰è½å°±ç¦»å¼€äº†è¿™ä¸ªä¸–ç•Œ\n'
        }
    } else {
    	State.variables.dropLog += enemy.name + 'ä¸å­˜åœ¨å¯æ‰è½çš„ç‰©å“ã€‚'
    }
});
<</script>>
<</silently>>
<span class='good'>$dropLog</span>


:: ç‰©å“æ  {"position":"875,100","size":"100,100"}
<<for _i, _item range  $inventory.items>>
	<<if _item.count > 0>>
    	åç§°: _item.name x _item.count <<if _item.useCallback>><<print '<<link "ä½¿ç”¨" "ç‰©å“æ ">><<set _temp to $globalUseCallback(' + _i + ')>><</link>>'>><</if>>
        _item.desc
    <</if>>
<</for>>

<<return "è¿”å›">>


:: ç‹ä¹‹é—´ {"position":"900,1025","size":"100,100"}
=<<print passage()>>=

å®½æ•çš„çŸ³å®¤ï¼Œä¸¤è¾¹æŒ‚ç€ç‚½çƒˆç‡ƒçƒ§çš„ç«æŠŠï¼Œ
å’Œå“¥å¸ƒæ—å·¢ç©´æ ¼æ ¼ä¸å…¥çš„å…‰æ™¯ã€‚

çŸ³å®¤æ·±å¤„æ‘†ç€ä¸€å¼ çŸ³æ¤…â€”â€”çœ‹æ ·å­æ˜¯ç›´æ¥ä»å²©å£ä¸Šå‡¿å‡ºæ¥çš„ï¼Œ
ä¸Šé¢åç€ä¸€åªå¤´æˆ´ç‹å† çš„å“¥å¸ƒæ—ã€‚

å“¥å¸ƒæ—ç‹ã€‚
å®ƒæ­£æ˜¯æˆ‘èº«å¤„æ­¤åœ°çš„åŸå› ã€‚
æˆ‘è¦æ€æ­»å®ƒï¼Œä¸ºæ­»å»çš„åŒä¼´ä»¬å¤ä»‡ã€‚
ç„¶åç¦»å¼€è¿™ä¸ªä»¤äººä¸é€‚çš„åœ°æ–¹ã€‚

åªä¸è¿‡ï¼Œåœ¨èƒ½å¤Ÿé è¿‘å®ƒä¹‹å‰ï¼Œè¿˜æœ‰ä¸å¾—ä¸å¯¹ä»˜çš„æ•Œäººâ€”â€”ä¸‰åªå“¥å¸ƒæ—éª‘å£«ã€‚
å®ƒä»¬æœ‰ç€å±±å²­å“¥å¸ƒæ—ä¸€æ ·çš„å·¨èº¯ï¼Œè¿˜èº«ç©¿ä»äººç±»å£«å…µé‚£é‡Œå¤ºæ¥çš„ç›”ç”²ã€‚

å®ƒä»¬å·²ç»å‘ç°äº†æˆ‘è¿™ä¸ªé—¯å…¥è€…ï¼Œä½†å´æŒ‰å…µä¸åŠ¨ã€‚
å› ä¸ºå“¥å¸ƒæ—ç‹åˆ¶æ­¢äº†å®ƒä»¬ã€‚

<<if not $goblinKingTalked>>ğŸŸ [[å¬å“¥å¸ƒæ—ç‹è¯´è¯]]<</if>>
è¿”å›[[å·¢ç©´æ·±å¤„]]


:: ç‹å›½æ—…è¡ŒæŒ‡å— {"position":"1000,400","size":"100,100"}
ç¿»å¼€ä¸€çœ‹ï¼Œé‡Œé¢çš„ä¹¦é¡µå…¨éƒ½è¢«æ’•æ‰äº†ï¼Œåªå‰©ä¸‹ä¸€å¼ çº¸ï¼Œä¸Šé¢æ½¦è‰åœ°å†™ç€ï¼š

<blockquote>
åœ¨å¤§æ´ªæ°´æ¥ä¸´ä¹‹å‰ï¼Œç¦»å¼€è¿™é‡Œ
<small>PS: æˆ‘æŠŠä¹¦å…¨éƒ½æ’•äº†ï¼Œå› ä¸ºä½ æ˜¯è‡ªç”±çš„</small>
</blockquote>

[[è€å¤´çš„æˆ¿é—´]]


:: ç‹éƒ½ {"position":"450,650","size":"100,100"}
ç¬¬äºŒç« â€¦â€¦
æ–½å·¥ä¸­â€¦â€¦


:: ç¥­å› {"position":"1025,1025","size":"100,100"}
(æ¸¸æˆè¿›åº¦æš‚æ—¶åªåˆ°è¿™é‡Œ)

[[å·¢ç©´æ·±å¤„]]


:: ç¦»å¼€è¿™é‡Œ {"position":"600,650","size":"100,100"}
= ç¬¬äºŒç«  =

[[ç»§ç»­->å“¥å¸ƒæ—å·¢ç©´è£‚ç¼]]

<<script>>
let G = State.variables
G.consideredInCave = false;
healing(G.me, 1.0); // å›å¤æ»¡hp
healing(G.me, -0.4); // è®¾ç½®ä¸º60%HP
addItem(G.inventory.items, G.smallHealingPotion);
G.me.weapon = G.bloodedIronSword;
G.me.armor = G.bloodedDeerskinArmor;
G.meetWallPenetrater = false; //æ˜¯å¦é‡è§ç©¿å¢™è€…
G.goblinKingTalked = false; //æ˜¯å¦ä¸å“¥å¸ƒæ—ç‹äº¤è°ˆ
<</script>>


:: ç§°å·æ  {"position":"1000,100","size":"100,100"}
<<for $i, $item range  $titles.items>>
	<<if $item.count > 0>>
    	ã€Š$item.nameã€‹<<if $item.count > 1>>x $item.count<</if>>
        $item.desc
    <</if>>
<</for>>

<<return "è¿”å›">>


:: è€å¤´çš„ä¿¡ {"position":"1000,550","size":"100,100"}
ä½ çœ‹åˆ°è¿™å°ä¿¡çš„æ—¶å€™ï¼Œæˆ‘å¤§æ¦‚å·²ç»æ­»äº†å§ã€‚
ä½ è‚¯å®šä»¥ä¸ºè¿™è€å¤´æˆ¿é—´é‡Œè—ç€ä¸å¾—äº†çš„ä¸œè¥¿ï¼Œ
ç»“æœåªå‘ç°äº†è¿™å°ä¿¡ã€‚

ä¸€å®šå¾ˆå¤±æœ›å§ã€‚
å¦‚æœæ˜¯æˆ‘çš„è¯ä¸€å®šä¼šå¾ˆå¤±æœ›ã€‚

ä¸è¿‡ä½ è‚¯å®šä¼šæƒ³ï¼šâ€œè¿™å°ä¿¡ä¸€å®šè—ç€å…³äºæˆ‘çš„èº«ä¸–çš„ä¸å¾—äº†çš„ç§˜å¯†â€ã€‚

æ˜¯çš„ï¼Œæˆ‘ä¼šå‘Šè¯‰ä½ ä¸€åˆ‡çœŸç›¸ã€‚

[[ä¸‹ä¸€é¡µ]]


:: è€å¤´çš„æˆ¿é—´ {"position":"850,425","size":"100,100"}
=è€å¤´çš„æˆ¿é—´=

<<if $oldMan.hp > 0>>
è€å¤´ï¼š ç«™ä½ã€‚è°å…è®¸ä½ éšä¾¿è¿›æˆ‘çš„æˆ¿é—´äº†ï¼Ÿ

çœ‹æ¥<span class='red'>è¦æƒ³è¿›å»è¿˜å¾—æƒ³æƒ³åŠæ³•</span>ã€‚
<<else>>
ç…é£æ™¯çš„æˆ¿é—´ã€‚
å®¶å…·å’Œæˆ‘è‡ªå·±çš„èµ·å±…å®¤å·®ä¸å¤šï¼Œä¸€å¼ åºŠï¼Œä¸€å¼ æ¡Œå­è€Œå·²ã€‚
æ¡Œå­ä¸Šæ‘†ç€[[ä¸€å°ä¿¡->è€å¤´çš„ä¿¡]]ï¼Œå’Œä¸€æœ¬ã€Š[[ç‹å›½æ—…è¡ŒæŒ‡å—]]ã€‹ã€‚
<</if>>


[[å¤§å…]]


:: èµ·å±…å®¤ {"position":"700,250","size":"100,100"}
=èµ·å±…å®¤=

ä¸€ä¸ªå°å°çš„æˆ¿é—´ï¼Œæ•´æ´ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯æ²¡æœ‰ä»€ä¹ˆç”Ÿæ´»æ°”æ¯ã€‚ 
ä¸€å¼ åºŠï¼Œä¸€å¼ æ¤…å­ï¼Œæ¡Œå­ã€‚
æ¡Œå­ä¸Šé¢æ”¾ç€[[ä¸€æœ¬ç¿»å¼€çš„ä¹¦]]ï¼Œè¿˜æœ‰èœ¡çƒ›ç‡ƒå°½ç•™ä¸‹çš„çƒ›æ³ªã€‚

<<if not $beginnerWeaponGot>>\
å¢™ä¸ŠæŒ‚ç€ä¸€æŸ„$beginnerWeapon['name']ã€‚\
<<link "è£…å¤‡" "èµ·å±…å®¤">>\
<<set $me.weapon to $beginnerWeapon>>\
<<set $beginnerWeaponGot to true>>\
<</link>>\
<<else>>\
ğŸŸ¢å¢™ä¸Šæ”¾æ­¦å™¨çš„åœ°æ–¹ç©ºç©ºå¦‚ä¹Ÿã€‚\
<</if>>\

<<if not $beginnerArmorGot>>\
å¢™ä¸ŠæŒ‚ç€ä¸€å¥—$beginnerArmor['name']ã€‚\
<<link "è£…å¤‡" "èµ·å±…å®¤">>\
<<set $me.armor to $beginnerArmor>>\
<<set $beginnerArmorGot to true>>\
<</link>>\
<<else>>\
ğŸŸ¢å¢™ä¸Šæ”¾é˜²å…·çš„åœ°æ–¹ç©ºç©ºå¦‚ä¹Ÿã€‚\
<</if>>\


[[ä¼‘æ¯]]
åˆ°[[å¤§å…]]å»ã€‚


:: StoryScript [script]
window.fightObjectCopy = function(obj){
	let resultObj = {};
	resultObj.name = obj.name;
	resultObj.hp = obj.hp;
	resultObj.max_hp = obj.max_hp;
	resultObj.resistance = obj.resistance;
	resultObj.power = obj.power;
	return resultObj;
}

window.fight = function fight(obj1, obj2, beforeFightCallbacks) {
    const calculateDamage = (attackerPower, defenderResistance) => Math.max(attackerPower - defenderResistance, 1);
    console.log('FIGHT!', obj1, obj2);
    
    let fightHistory = [];
	//å¾ªç¯è°ƒç”¨beforeFightCallbacksï¼Œæ¯ä¸ªcallbackæ¥å—obj1å’Œobj2ä½œä¸ºå‚æ•°ï¼Œæœ€åè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºè®°å½•ï¼Œå°†è¿™ä¸ªå­—ç¬¦ä¸²å­˜å…¥fightHistoryã€‚
    beforeFightCallbacks.forEach(callback => {
        // Each callback is called with obj1 and obj2 as arguments
        let result = callback(obj1, obj2);
        // Push the result into the fightHistory array
        fightHistory.push(result);
    });
	
    let { hp: hp1, power: power1, resistance: res1, name: name1 } = obj1;
    let { hp: hp2, power: power2, resistance: res2, name: name2 } = obj2;

    
    let round = 1;

    while (hp1 > 0 && hp2 > 0) {
        fightHistory.push(`å›åˆ${round}`);
        let damage = calculateDamage(power1, res2);
        hp2 = Math.max(hp2 - damage, 0);
        fightHistory.push(`${name1}å¯¹${name2}é€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`);
        if (hp2 === 0) {
            fightHistory.push(`${name2}å€’ä¸‹äº†ï¼Œæˆ˜æ–—ç»“æŸï¼`);
            break;
        }

        damage = calculateDamage(power2, res1);
        hp1 = Math.max(hp1 - damage, 0);
        fightHistory.push(`${name2}å¯¹${name1}é€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`);
        if (hp1 === 0) {
            fightHistory.push(`${name1}å€’ä¸‹äº†ï¼Œæˆ˜æ–—ç»“æŸï¼`);
            break;
        }

        round++;
    }

    obj1.hp = hp1;
    obj2.hp = hp2;
    return fightHistory;
}

function loopCall(callbackName, group1, group2, callbackFuncDict, fightHistory = []){
  	for (let i = 0; i< group1.length; i++){
    	if (callbackFuncDict['g1'][i] && callbackFuncDict['g1'][i][callbackName]) {
        	callbackFuncDict['g1'][i][callbackName](group1, group2, fightHistory);
        }
    }
  	for (let i = 0; i< group2.length; i++){
    	if (callbackFuncDict['g2'][i] && callbackFuncDict['g2'][i][callbackName]) {
        	callbackFuncDict['g2'][i][callbackName](group2, group1);
        }
    }
  	
}

window.groupFight = function groupFight(group1, group2, callbackFuncDict = {'g1': {}, 'g2': {}}) {
  	window.temp2 = callbackFuncDict;

  
    const calculateDamage = (attackerPower, defenderResistance) => Math.max(attackerPower - defenderResistance, 1);
    let fightHistory = [];
    let round = 1;
    
    // æ£€æŸ¥æ‰€æœ‰è§’è‰²çš„HPæ˜¯å¦éƒ½ä¸º0
    const isGroupAlive = group => group.some(obj => obj.hp > 0);
  
  	loopCall('groupModifier', group1, group2, callbackFuncDict, fightHistory);
  	console.log('Print our members for check');
  	for (const us of group1){
    	console.log(us.name);
    }

    while (isGroupAlive(group1) && isGroupAlive(group2)) {
        fightHistory.push(`<span class="important">å›åˆ${round}</span>`);
        fightHistory.push('<span class="good">' + group1[0].name + 'çš„é˜Ÿä¼å±•å¼€æ”»å‡»ã€‚</span>');
        // Group1æ”»å‡»Group2
        for (let i = 0; i < group1.length; i++) {
            let obj1 = group1[i]
          	if (obj1.hp <= 0) continue;  // è·³è¿‡å·²å€’ä¸‹çš„è§’è‰²
            for (let obj2 of group2) {
                if (obj2.hp <= 0) continue;  // è·³è¿‡å·²å€’ä¸‹çš„è§’è‰²
              	let damage = 0;
              	if (i in callbackFuncDict['g1'] && 'damageCalculator' in callbackFuncDict['g1'][i]){
                  	console.log('G1111')
                	damage = callbackFuncDict['g1'][i]['damageCalculator'](obj1, obj2, fightHistory);
                } else {
                	damage = calculateDamage(obj1.power, obj2.resistance);
                }
                obj2.hp = Math.max(obj2.hp - damage, 0);
                fightHistory.push(`${obj1.name}å¯¹${obj2.name}é€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`);

                if (obj2.hp === 0) {
                    fightHistory.push(`${obj2.name}å€’ä¸‹äº†ï¼`);
                }
            }
        }

        // å¦‚æœgroup2å·²ç»å…¨éƒ¨å€’ä¸‹ï¼Œç»“æŸæˆ˜æ–—
        if (!isGroupAlive(group2)) {
            fightHistory.push(group2[0].name + "çš„é˜Ÿä¼å…¨å‘˜å€’ä¸‹ï¼Œæˆ˜æ–—ç»“æŸï¼");
            break;
        }

        fightHistory.push('<span class="red">' + group2[0].name + 'çš„é˜Ÿä¼å±•å¼€æ”»å‡»ã€‚</span>');
        // Group2æ”»å‡»Group1
        for (let i = 0; i < group2.length; i++) {
          	let obj2 = group2[i]
            if (obj2.hp <= 0) continue;  // è·³è¿‡å·²å€’ä¸‹çš„è§’è‰²
            for (let obj1 of group1) {
                if (obj1.hp <= 0) continue;  // è·³è¿‡å·²å€’ä¸‹çš„è§’è‰²
              	let damage = 0;
              	if (i in callbackFuncDict['g2'] && 'damageCalculator' in callbackFuncDict['g2'][i]){
                  	console.log('G222')
                	damage = callbackFuncDict['g2'][i]['damageCalculator'](obj1, obj2);
                } else {
                	damage = calculateDamage(obj2.power, obj1.resistance);
                }
                obj1.hp = Math.max(obj1.hp - damage, 0);
                fightHistory.push(`${obj2.name}å¯¹${obj1.name}é€ æˆäº†${damage}ç‚¹ä¼¤å®³ï¼`);

                if (obj1.hp === 0) {
                    fightHistory.push(`${obj1.name}å€’ä¸‹äº†ï¼`);
                }
            }
        }

        // å¦‚æœgroup1å·²ç»å…¨éƒ¨å€’ä¸‹ï¼Œç»“æŸæˆ˜æ–—
        if (!isGroupAlive(group1)) {
            fightHistory.push(group1[0].name + "çš„é˜Ÿä¼å…¨å‘˜å€’ä¸‹ï¼Œæˆ˜æ–—ç»“æŸï¼");
            break;
        }

        round++;
    }

    return fightHistory;
}


window.dropItems = function dropItems(drops) {
    let itemList = [];

    // éå†dropsæ•°ç»„
    drops.forEach(drop => {
        // ç”Ÿæˆä¸€ä¸ªéšæœºæ•° (0-1)
        let randomChance = Math.random();
      	console.log(randomChance)
      	console.log(drop.chance)
        
        // å¦‚æœéšæœºæ•°å°äºç­‰äºæ‰è½å‡ ç‡ï¼Œåˆ™æ‰è½ç‰©å“
        if (randomChance <= drop.chance) {
            itemList.push(drop.item);
        }
    });

    return itemList; // è¿”å›æ‰è½çš„ç‰©å“åˆ—è¡¨
}

window.dropString = function dropString(droppedItems) {
    // å¦‚æœdroppedItemsä¸ºç©ºï¼Œè¿”å›æç¤ºä¿¡æ¯
    if (droppedItems.length === 0) {
        return "æ²¡æœ‰ç‰©å“æ‰è½";
    }
    
    // æå–æ¯ä¸ªç‰©å“çš„åå­—ï¼Œå¹¶ç”¨é€—å·è¿æ¥æˆå­—ç¬¦ä¸²
    let itemNames = droppedItems.map(item => item.name);
    return itemNames.join(', ');
}

window.addToInventory = function(inventory, itemList) {
    itemList.forEach(item => {
        // æ£€æŸ¥ inventory ä¸­æ˜¯å¦å·²æœ‰è¯¥ç‰©å“
        let existingItem = inventory.find(inventoryItem => inventoryItem.name === item.name);
        
        if (existingItem) {
            // å¦‚æœå·²æœ‰è¯¥ç‰©å“ï¼Œå¢åŠ  count
            existingItem.count++;
        } else {
            // å¦‚æœæ²¡æœ‰ï¼Œæ–°å¢ç‰©å“å¹¶è®¾ç½® count ä¸º 1
            inventory.push({ ...item, count: 1 });
        }
    });
}

window.checkHavingItem = function(inventory, itemName) {
    // æŸ¥æ‰¾ inventory ä¸­çš„ç‰©å“
    let item = inventory.find(inventoryItem => inventoryItem.name === itemName);
    
    // å¦‚æœç‰©å“ä¸å­˜åœ¨ï¼Œæˆ–è€… count ä¸º 0ï¼Œè¿”å› falseï¼ˆä¸æŒæœ‰ï¼‰
    if (!item || item.count === 0) {
        return false;
    }
    
    // å¦åˆ™è¿”å› trueï¼ˆæŒæœ‰ï¼‰
    return true;
}

window.getItem = function getItem(inventory, itemName) {
    // æŸ¥æ‰¾ inventory ä¸­çš„ç‰©å“
    let item = inventory.find(inventoryItem => inventoryItem.name === itemName);
    
    // å¦‚æœç‰©å“å­˜åœ¨ï¼Œè¿”å›è¯¥ç‰©å“ï¼Œå¦åˆ™è¿”å› null
    return item || null;
}

window.reduceItemCount = function reduceItemCount(inventory, itemName, count) {
    // æŸ¥æ‰¾ inventory ä¸­çš„ç‰©å“
    let item = inventory.find(inventoryItem => inventoryItem.name === itemName);
    
    if (item) {
        // å‡å°‘ç‰©å“æ•°é‡
        item.count -= count;
        
        // å¦‚æœç‰©å“æ•°é‡å°äºç­‰äº 0ï¼Œå°† count è®¾ä¸º 0
        if (item.count <= 0) {
            item.count = 0;
        }
    } else {
        console.log(`ç‰©å“ ${itemName} ä¸å­˜åœ¨äº inventory ä¸­ã€‚`);
    }
}

window.addItem = function addItem(inventory, item, count = 1) {
    // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰è¯¥ç‰©å“
    let existingItem = inventory.find(inventoryItem => inventoryItem.name === item.name);
    
    if (existingItem) {
        // å¦‚æœæŒæœ‰ï¼Œæ›´æ–°ç‰©å“çš„æ•°é‡å’Œæè¿°
        existingItem.count += count;
        existingItem.desc = item.desc;  // æ›´æ–°ç‰©å“çš„æè¿°
    } else {
        // å¦‚æœä¸æŒæœ‰ï¼Œæ–°å¢ç‰©å“å¹¶è®¾ç½® count
        inventory.push({ ...item, count: count });
    }
}

window.healing = function healing(target, percentage) {
    // è®¡ç®—æ¢å¤çš„ç”Ÿå‘½å€¼
    const healAmount = target.max_hp * percentage;
    
    // å¢åŠ ç”Ÿå‘½å€¼ï¼Œä½†ä¸èƒ½è¶…è¿‡max_hp
    target.hp = Math.min(target.hp + healAmount, target.max_hp);
    
    return target.hp; // è¿”å›æ›´æ–°åçš„ç”Ÿå‘½å€¼
  
}

// å‡çº§
window.levelUp = function(target){
  	target.level += 1
  	target.intrinsicPower += 1
  	target.intrinsicResistance += 1
  	target.max_hp += 10
  	console.log(target.name + ' Level Up!')
}

window.expCurve = function expCurve(level) {
    return Math.floor(5 * Math.pow(level, 2)); // ç»éªŒå€¼éœ€æ±‚é€’å¢æ›²çº¿
}

window.expGot = function expGot(expBefore, expGot, level, levelUp) {
    let expNew = expBefore + expGot; // è®¡ç®—æ–°ç»éªŒå€¼
    let levelsGained = 0; // ç”¨äºè¿½è¸ªå‡äº†å¤šå°‘çº§

    // å¾ªç¯æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
    while (expNew >= expCurve(level)) {
        expNew -= expCurve(level); // å‡å»å½“å‰çº§åˆ«çš„ç»éªŒéœ€æ±‚
        level += 1; // å‡ä¸€çº§
        levelsGained += 1; // è®°å½•å‡ä¸€çº§
        levelUp(); // è°ƒç”¨levelUpå‡½æ•°
    }

    return { newExp: expNew, newLevel: level, levelsGained: levelsGained };
}

:: StoryStylesheet [stylesheet]
.danger{
	color: red;
}
.good{
	color: #90EE90;
}
.important{
  	color: orange;
}
.red{
	color: red;
}